worker_processes 1;

events { worker_connections 1024; }

http {
    # Map subdomain to redirect path
    map $host $redirect_path {
        default "";
        ~^(?<subdomain>[a-z0-9-]+)\.id\.docker$ /$subdomain;
    }

    server {
        listen 80;

        # Preflight OPTIONS
        location / {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
                add_header Access-Control-Allow-Credentials true always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }

            # Trigger subdomain redirect
            error_page 418 = @subdomain_redirect;
            return 418;
        }

        # Named location for subdomain redirect
        location @subdomain_redirect {
            if ($redirect_path != "") {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
                add_header Access-Control-Allow-Credentials true always;
                return 303 https://id.docker$redirect_path;
            }
            return 404;
        }

        # TTL files
        location ~* ^/(.+)$ {
            alias /usr/share/nginx/html/id/$1.ttl;
            default_type text/turtle;

            # CORS headers
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
            add_header Access-Control-Allow-Credentials true always;

            # Handle preflight
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
                add_header Access-Control-Allow-Credentials true always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log warn;
    }
}

