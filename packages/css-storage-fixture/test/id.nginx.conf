worker_processes 1;

events { worker_connections 1024; }

http {
    server {
        listen 443 ssl;
        server_name _;

        ssl_certificate     /certs/cert.pem;
        ssl_certificate_key /certs/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers off;

        location ~* ^/(test-client)$ {
            alias /usr/share/nginx/html/id/$1.jsonld;

            types { }
            default_type application/ld+json;

            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
            add_header Access-Control-Allow-Credentials true always;

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
                add_header Access-Control-Allow-Credentials true always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        location ~* ^/(.+)$ {
            alias /usr/share/nginx/html/id/$1.ttl;

            types { }
            default_type text/turtle;

            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
            add_header Access-Control-Allow-Credentials true always;

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type,DPoP" always;
                add_header Access-Control-Allow-Credentials true always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        location @try_jsonld {
            internal;
            rewrite ^/(.+)$ /jsonld-$1 last;
        }

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log warn;
    }
}
